# TTS文本优化说明

## 问题描述
DeepSeek生成的话术包含各种非标点符号，这些符号对TTS语音合成没有意义，可能影响语音质量。

## 解决方案

### 1. 改进的Prompt设计
在 `agent/dh_clients.py` 中优化了DeepSeek的提示词：

```python
prompt = f"""
请为"{product_info}"生成一段直播带货话术，要求：
1. 长度约{paragraph_length}字符
2. 内容连贯，语言生动
3. 包含产品介绍、优惠信息、购买引导
4. 语气亲切自然，适合直播场景
5. 只使用基本标点符号（句号、逗号、问号、感叹号），不要使用其他符号
6. 不要使用引号、括号、星号、井号等特殊符号
7. 直接返回话术内容，不要其他说明
"""
```

### 2. 智能文本清理函数
添加了 `_clean_text_for_tts()` 方法，自动清理生成的文本：

```python
def _clean_text_for_tts(self, text: str) -> str:
    """清理文本，只保留标点符号，去除其他符号"""
    # 保留的标点符号：句号、逗号、问号、感叹号、顿号、分号、冒号
    allowed_punctuation = '。，？！、；：'
    
    # 移除所有非中文、非英文、非数字、非允许标点的字符
    cleaned_text = re.sub(r'[^\u4e00-\u9fa5a-zA-Z0-9\s。，？！、；：]', '', text)
    
    # 清理多余的空格
    cleaned_text = re.sub(r'\s+', ' ', cleaned_text).strip()
    
    return cleaned_text
```

### 3. 保留的字符类型
- ✅ **中文字符**: \u4e00-\u9fa5
- ✅ **英文字符**: a-zA-Z  
- ✅ **数字字符**: 0-9
- ✅ **空格字符**: \s
- ✅ **基本标点**: 。，？！、；：

### 4. 移除的符号类型
- ❌ **引号**: " ' " ' 
- ❌ **括号**: ( ) [ ] { }
- ❌ **特殊符号**: * # @ $ % & + = ~ ` ^ | \ / < >
- ❌ **货币符号**: ￥ € £ 
- ❌ **商标符号**: © ® ™
- ❌ **其他装饰符号**: ★ ☆ ♥ ♦ ♠ ♣

## 改进效果

### 改进前的话术示例：
```
宝宝们！这个产品【超值优惠】来啦~现在下单立享8折优惠！！！价格真的太"划算"了(*^_^*)
```

### 改进后的话术示例：
```
宝宝们！这个产品超值优惠来啦，现在下单立享8折优惠！价格真的太划算了。
```

## 测试验证
运行测试脚本验证清理效果：

```bash
python test_tts_text_cleaning.py
```

测试内容包括：
1. 各种符号的清理测试
2. 备用话术的清理验证
3. API生成话术的清理验证
4. 字符分析和规则说明

## 使用说明

### 自动清理
所有通过 `DeepSeekClient.generate_paragraph_script()` 生成的话术都会自动清理，无需额外操作。

### 手动清理
如果需要清理其他文本，可以直接调用清理方法：

```python
from agent.dh_clients import DeepSeekClient

client = DeepSeekClient()
cleaned_text = client._clean_text_for_tts("包含符号的文本【测试】")
```

## 注意事项

1. **标点符号保留**: 基本标点符号（。，？！、；：）会被保留，因为它们对TTS语音合成有意义
2. **数字保留**: 价格、数量等数字信息会被保留
3. **英文保留**: 品牌名、型号等英文内容会被保留
4. **日志记录**: 清理过程会记录移除的符号，便于调试

## 兼容性
- 兼容现有的话术生成流程
- 不影响其他功能模块
- 支持备用话术的自动清理

现在生成的话术更适合TTS语音合成，语音质量应该会有明显提升！