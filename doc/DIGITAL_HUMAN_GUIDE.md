# 🤖 数字人直播系统使用指南

## 📋 系统概述

这是一个完整的数字人直播系统，集成了：
- ✅ **TTS语音合成** - GPT-SoVITS
- ✅ **HuBERT特征提取** - 音频特征处理
- ✅ **数字人视频生成** - 使用您训练的模型
- ✅ **UDP实时推流** - 推送到VLC播放器

## 🚀 快速开始

### 1. 启动TTS服务
```bash
cd /mnt/e/CYC/projects/live-selling/GPT-SoVITS
python api_v2.py
```

### 2. 运行数字人系统
```bash
cd /mnt/e/CYC/projects/live-selling/UDH
python3 digital_human_system.py
```

### 3. 在VLC中观看
1. 打开VLC媒体播放器
2. 媒体 → 打开网络串流
3. 输入: `udp://@:1234`
4. 点击播放

## 📁 文件结构

```
UDH/
├── digital_human_system.py    # 主系统文件
├── test_digital_human.py      # 测试脚本
├── data_utils/hubert.py       # HuBERT特征提取
├── inference.py               # 数字人推理
├── checkpoint/195.pth         # 训练好的模型
├── input/mxbc_0913/          # 数据集目录
└── temp/                     # 临时文件目录
```

## 🔧 系统工作流程

1. **文本输入** → 用户输入直播文本
2. **TTS生成** → 生成语音音频文件
3. **特征提取** → 使用HuBERT提取音频特征
4. **视频生成** → 使用训练模型生成数字人视频
5. **UDP推流** → 实时推送到VLC播放器
6. **文件清理** → 只保留必要的mp4文件

## 📊 测试结果

根据最新测试：
- ✅ **TTS生成**: 正常工作
- ✅ **视频生成**: 正常工作（包含回退机制）
- ✅ **UDP推流**: 正常工作

## ⚙️ 配置说明

### TTS配置
- 服务地址: `http://127.0.0.1:9880/tts`
- 参考音频: `/mnt/e/CYC/projects/live-selling/assets/250911/reference.FLAC`
- 参考文本: "宝宝，先让我们点击右下角小黄车里头，您点击任意一个链接点进去以后"

### 数字人模型配置
- 数据集: `input/mxbc_0913/`
- 模型: `checkpoint/195.pth`
- ASR模式: `hubert`

### 推流配置
- 协议: UDP
- 端口: 1234
- 编码器: libopenh264 + libmp3lame

## 🛠️ 故障排除

### 1. VLC看不到视频
- 尝试不同的URL格式：
  - `udp://@:1234`
  - `udp://127.0.0.1:1234`
  - `udp://0.0.0.0:1234`
- 检查防火墙设置
- 调整VLC缓冲设置

### 2. HuBERT处理超时
- 系统会自动回退到简单视频生成
- 可以调整超时时间或优化音频长度

### 3. TTS生成失败
- 检查GPT-SoVITS服务是否运行
- 确认NLTK资源已安装
- 检查参考音频文件是否存在

### 4. 模型推理失败
- 确认数据集目录存在
- 检查模型文件是否完整
- 验证CUDA环境配置

## 📝 使用示例

```python
# 启动系统后，在控制台输入：
输入文本: 欢迎来到蜜雪冰城直播间
输入文本: 今天有超值优惠活动
输入文本: 点击小黄车查看详情
输入文本: quit  # 退出系统
```

## 🔄 系统特性

### 自动回退机制
- 如果数字人生成失败，自动回退到简单视频
- 确保直播不中断

### 文件管理
- 自动清理中间文件（音频、特征文件）
- 只保留最终的mp4视频文件
- 推流完成后自动删除视频文件

### 队列管理
- 文本队列：最多10个待处理文本
- 视频队列：最多5个待推流视频
- 防止内存溢出

## 📈 性能优化

### 建议配置
- GPU内存：至少4GB
- 系统内存：至少8GB
- 存储空间：至少2GB可用空间

### 优化建议
- 控制文本长度（建议50字以内）
- 避免过于频繁的文本输入
- 定期清理temp目录

## 🎯 下一步改进

1. **性能优化**
   - 优化HuBERT处理速度
   - 实现模型预加载
   - 添加GPU加速

2. **功能增强**
   - 支持多种语言
   - 添加表情控制
   - 实现背景替换

3. **稳定性提升**
   - 增强错误处理
   - 添加健康检查
   - 实现自动重启

## 📞 技术支持

如果遇到问题，请：
1. 查看日志文件：`digital_human.log`
2. 运行测试脚本：`python3 test_digital_human.py`
3. 检查系统资源使用情况
4. 确认所有依赖服务正常运行

---

**🎉 恭喜！您的数字人直播系统已经可以正常使用了！**